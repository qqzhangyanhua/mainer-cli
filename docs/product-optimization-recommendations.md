# OpsAI 产品优化建议报告

> 目标用户：不懂运维的开发者/产品经理
> 核心价值：通过自然语言快速解决"项目启动、状态查看、日志排查、服务重启"这 4 大核心场景

---

## 📊 当前项目现状

### ✅ 做得好的地方
1. **架构清晰**：Orchestrator-Workers 分离，易于扩展
2. **安全机制**：三层防护（危险检测 + 确认 + 审计）做得扎实
3. **ReAct 循环**：多步任务编排逻辑完善
4. **Dry-run 模式**：对生产环境友好
5. **测试覆盖**：28 个测试文件，质量意识较高

### ⚠️ 存在的问题

#### 1. **功能发散，未聚焦核心场景**
- 当前有 10 个 Workers（system, container, shell, analyze, deploy, http, tavily, chat, audit, cache）
- 对于"不懂运维的人"，80% 的需求只需要 3-4 个核心功能
- **问题**：用户学习成本高，文档难以聚焦

#### 2. **GitHub 部署功能过度设计**
- `deploy.py` 实现了完整的 analyze_repo → clone_repo → setup_env → start_service 流程
- **问题**：
  - 对新手来说流程太复杂
  - 项目类型检测不可靠（README 信息不足时需要 tavily 搜索）
  - 用户更需要："给我一个 URL，直接启动"的傻瓜式体验
- **建议**：简化为 `opsai deploy <github-url>`，内部自动完成所有步骤

#### 3. **Tavily 搜索集成价值有限**
- 添加了外部依赖 `tavily-python`
- **问题**：
  - 运维场景很少需要实时搜索
  - 增加 API 配置成本
  - 可能导致 LLM 生成不确定性（搜索结果质量不可控）
- **建议**：移除或作为可选插件，核心功能不应依赖外部搜索

#### 4. **模板系统对新手不友好**
- 任务模板（templates/）概念需要学习 JSON 格式
- **问题**：
  - 目标用户"不懂运维"，也很可能"不懂模板"
  - 预置模板不够（只有 4 个）
  - 缺少"场景推荐"机制
- **建议**：
  - 改为"场景卡片"UI（如："磁盘快满了怎么办？"→ 点击执行）
  - 模板自动生成（LLM 根据用户历史自动创建常用流程）

#### 5. **Workers 职责重叠**
- `analyze.py` + `cache.py` 分离不合理（analyze 本身就应该内置缓存）
- `shell.py` + `system.py` 功能有重叠
- **建议**：
  - 合并 cache 逻辑到 analyze 内部
  - 明确 shell（通用命令）vs system（文件系统专项）的边界

#### 6. **缺少"新手引导"和"智能推荐"**
- 首次运行没有引导流程
- 没有根据用户环境推荐高频场景
- **建议**：
  - 首次启动检测环境（Docker? Systemd? K8s?）
  - 推荐前 3 个最常用操作（如："查看所有容器"、"查看日志"、"检查磁盘"）

#### 7. **文档分散，缺少"快速上手"**
- README.md 很全面，但新手不知道从哪开始
- **建议**：
  - 增加 "5 分钟快速上手" 章节，只讲 3 个最常用命令
  - 用动图/截图展示 TUI 交互

---

## 🎯 核心优化建议

### 优先级 P0（必须做）

#### 1. 聚焦 4 大核心场景
**删除或降级**：
- ❌ Tavily 搜索（移除依赖）
- ❌ Deploy Worker 的复杂流程（简化为一键部署）
- ❌ 独立的 Cache Worker（合并到 analyze）

**强化核心**：
- ✅ **查看服务**：`docker ps`, `systemctl status`, `ps aux`
- ✅ **查看日志**：`docker logs`, `journalctl`, `tail`
- ✅ **重启服务**：`docker restart`, `systemctl restart`
- ✅ **资源检查**：`df -h`, `free -m`, `top`

#### 2. 优化首次体验
```bash
# 首次运行自动检测环境
$ opsai-tui

╭─────────────────────────────────────╮
│  🎉 欢迎使用 OpsAI！                │
│                                     │
│  检测到你的环境：                    │
│  ✓ Docker 正在运行 (3 个容器)       │
│  ✓ Systemd 服务管理器               │
│                                     │
│  推荐你试试这些操作：                │
│  1️⃣  查看所有容器状态               │
│  2️⃣  查看磁盘使用情况               │
│  3️⃣  查看最近的系统日志             │
╰─────────────────────────────────────╯
```

#### 3. 简化 GitHub 部署
```python
# 旧的（5 步）
opsai query "部署 https://github.com/user/repo"
# → 用户需要理解 analyze、clone、setup、start 4 个步骤

# 新的（1 步）
opsai deploy https://github.com/user/repo
# → 自动完成所有步骤，实时显示进度
# → 失败时智能提示（如："缺少 .env 文件，已从 .env.example 创建，请修改后重试"）
```

### 优先级 P1（应该做）

#### 4. 增强智能对话
```bash
# 当前：需要用户明确指定
opsai query "查看 nginx 容器的日志"

# 优化：支持模糊意图
opsai query "我的网站打不开了"
→ AI: "检测到 nginx 容器正在运行，但端口 80 未监听，是否查看日志？[y/n]"

# 支持连续对话（TUI 模式）
> "我的服务出问题了"
→ "你有 3 个服务，是指哪个：1. nginx  2. mysql  3. redis"
> "第一个"
→ "nginx 容器状态：运行中，但 CPU 使用率 90%，是否重启？"
```

#### 5. 场景化模板（替代当前的 JSON 模板）
```bash
# 内置"场景卡片"，而不是"模板"
opsai scenarios

╭─ 常见问题 ────────────────────────╮
│ 🔴 服务无响应                      │
│    → 检查容器状态 + 查看日志      │
│                                    │
│ 💾 磁盘空间不足                    │
│    → 查找大文件 + 清理日志        │
│                                    │
│ 🐌 服务响应慢                      │
│    → 查看资源占用 + 重启服务      │
╰────────────────────────────────────╯

# 点击场景，自动执行多步操作
```

#### 6. 智能错误提示
```bash
# 当前：执行失败后，用户不知道怎么办
$ opsai query "重启 nginx"
✗ Failed: Container 'nginx' not found

# 优化：提供可操作的建议
$ opsai query "重启 nginx"
✗ 未找到名为 'nginx' 的容器

💡 建议：
  1. 查看所有容器：opsai query "列出所有容器"
  2. 如果是 systemd 服务：opsai query "重启 nginx.service"
  3. 如果是进程：opsai query "重启 nginx 进程"
```

### 优先级 P2（可以做）

#### 7. 可视化增强（TUI 模式）
- 容器/进程列表用表格展示（当前是纯文本）
- 日志支持高亮关键词（ERROR, WARN, Exception）
- 资源占用用进度条展示（不是纯数字）

#### 8. 历史记录和收藏
```bash
# 保存常用操作
opsai bookmark "查看 api-server 的日志" --alias "api-log"

# 快速调用
opsai run api-log
```

---

## 🔧 技术实现建议

### 重构优先级

#### 立即重构（影响核心体验）
1. **合并 Workers**：
   ```python
   # 删除 src/workers/cache.py
   # 将缓存逻辑移入 src/workers/analyze.py 内部
   class AnalyzeWorker:
       def __init__(self, llm_client):
           self._cache = self._load_cache()  # 内部管理
   ```

2. **简化 deploy.py**：
   ```python
   # 新增一个高层方法
   async def one_click_deploy(self, repo_url: str) -> WorkerResult:
       # 内部自动调用 analyze → clone → setup → start
       # 对外暴露单一接口
   ```

3. **移除 Tavily 依赖**：
   ```bash
   # pyproject.toml
   - "tavily-python>=0.5.0",  # 删除
   
   # src/workers/tavily.py  # 删除整个文件
   ```

#### 短期优化（1-2 周）
4. **新增首次引导**：
   ```python
   # src/tui.py
   def on_mount(self):
       if self._is_first_run():
           self._show_welcome_wizard()
   ```

5. **场景推荐系统**：
   ```python
   # src/orchestrator/scenarios.py (新建)
   class ScenarioRecommender:
       def detect_environment(self) -> list[Scenario]:
           # 检测 Docker/Systemd/K8s
           # 返回推荐场景列表
   ```

#### 中期优化（1 个月）
6. **智能错误提示**：
   ```python
   # src/orchestrator/error_helper.py (新建)
   class ErrorHelper:
       def suggest_fix(self, error: WorkerResult) -> list[str]:
           # 根据错误类型返回建议
   ```

---

## 📝 文档优化建议

### README.md 重构
**当前问题**：太长，新手不知道从哪开始

**建议结构**：
```markdown
# OpsAI - 5 分钟学会运维

## 快速开始（新手必看）
1. 安装：`pip install opsai`
2. 启动：`opsai-tui`
3. 试试这 3 个命令：
   - "查看所有容器"
   - "查看磁盘空间"
   - "查看最近的日志"

[📺 观看 30 秒演示视频]

## 常见问题（按场景分类）
### 🔴 服务出问题了
- "我的网站打不开" → 检查容器/进程
- "日志在哪里" → 自动查找日志位置
- "怎么重启服务" → 识别服务类型自动重启

### 💾 磁盘满了
- "清理临时文件" → 自动查找可清理的文件
- "找出大文件" → 列出超过 100MB 的文件

### 🐌 服务很慢
- "检查资源占用" → 显示 CPU/内存/磁盘
- "重启服务" → 安全重启流程

## 进阶用法（可选）
- 部署 GitHub 项目
- 自定义场景
- ...
```

### 新增文档
1. **QUICKSTART.md**：只讲最基础的 3 个操作，带截图
2. **SCENARIOS.md**：按场景分类的完整示例（服务故障、磁盘清理、日志分析）
3. **FAQ.md**：真实用户问题汇总

---

## 🎨 产品定位建议

### 当前定位（模糊）
"基于 LLM 的终端智能运维助手"
→ 用户不知道这跟 ChatGPT 有什么区别

### 建议定位（清晰）
**"5 分钟学会运维的智能助手"**

核心卖点：
1. **无需记命令**：自然语言就能操作
2. **自动检测环境**：Docker、Systemd、K8s 自动识别
3. **安全防护**：危险操作自动拦截 + 确认
4. **场景化指导**："我的服务出问题了" → 自动排查

### 目标用户画像
1. **主要用户**（80%）：
   - 前端/全栈开发者，需要部署个人项目
   - 产品经理/设计师，需要查看测试环境状态
   - **需求**：查日志、重启服务、检查磁盘，仅此而已

2. **次要用户**（15%）：
   - 初级运维，需要快速完成重复任务
   - **需求**：批量操作、任务自动化

3. **高级用户**（5%）：
   - 运维专家，需要自定义复杂流程
   - **需求**：扩展 Worker、编写模板

**产品策略**：
- **满足 80% 主要用户的核心场景**（P0）
- 兼顾 15% 次要用户的效率需求（P1）
- 为 5% 高级用户提供扩展能力（P2）

---

## ✅ 行动计划

### 第一阶段：聚焦核心（1-2 周）
- [ ] 移除 Tavily 依赖
- [ ] 合并 cache.py 到 analyze.py
- [ ] 简化 deploy 为一键部署
- [ ] 重写 README（增加"5 分钟快速上手"）

### 第二阶段：优化体验（2-4 周）
- [ ] 增加首次运行引导
- [ ] 实现场景推荐系统
- [ ] 优化错误提示（提供可操作建议）
- [ ] 录制演示视频

### 第三阶段：精细打磨（1-2 月）
- [ ] TUI 可视化增强（表格、进度条、高亮）
- [ ] 历史记录和收藏功能
- [ ] 用户行为分析（哪些场景最常用？）

---

## 📊 成功指标

**产品目标**：让不懂运维的人，在 5 分钟内能独立完成：
1. 查看服务状态（3 分钟）
2. 查看日志找问题（5 分钟）
3. 重启服务解决故障（5 分钟）

**衡量指标**：
- 首次成功操作时间 < 5 分钟
- 核心场景（查日志/重启/检查资源）覆盖 90% 的用户请求
- 用户放弃率 < 20%（首次运行到成功操作）

---

## 💡 总结

**核心思想**：
> "不要让用户学习 OpsAI，而是让 OpsAI 理解用户"

**三个关键点**：
1. **减法而非加法**：删掉 30% 的功能，让核心场景体验提升 300%
2. **场景而非功能**：不要说"我们有 10 个 Workers"，而要说"我们能解决 5 大运维问题"
3. **引导而非文档**：用户不应该"读文档学习"，而应该"跟着提示操作"

**下一步**：
建议先实现"第一阶段"的 4 项重构，然后邀请 5-10 个真实的"不懂运维的用户"试用，收集反馈后再决定第二阶段的优先级。
